

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>LLVM Testing Infrastructure Guide &#8212; LLVM 9 documentation</title>
    <link rel="stylesheet" href="_static/llvm-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="test-suite Guide" href="TestSuiteGuide.html" />
    <link rel="prev" title="Code Reviews with Phabricator" href="Phabricator.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="TestSuiteGuide.html" title="test-suite Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Phabricator.html" title="Code Reviews with Phabricator"
             accesskey="P">previous</a> |</li>
  <li><a href="http://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>


    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="llvm-testing-infrastructure-guide">
<h1>LLVM Testing Infrastructure Guide<a class="headerlink" href="#llvm-testing-infrastructure-guide" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#requirements" id="id3">Requirements</a></p></li>
<li><p><a class="reference internal" href="#llvm-testing-infrastructure-organization" id="id4">LLVM Testing Infrastructure Organization</a></p>
<ul>
<li><p><a class="reference internal" href="#unit-tests" id="id5">Unit tests</a></p></li>
<li><p><a class="reference internal" href="#regression-tests" id="id6">Regression tests</a></p></li>
<li><p><a class="reference internal" href="#test-suite" id="id7"><code class="docutils literal notranslate"><span class="pre">test-suite</span></code></a></p></li>
<li><p><a class="reference internal" href="#debugging-information-tests" id="id8">Debugging Information tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#quick-start" id="id9">Quick start</a></p>
<ul>
<li><p><a class="reference internal" href="#unit-and-regression-tests" id="id10">Unit and Regression tests</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id11">Debugging Information tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#regression-test-structure" id="id12">Regression test structure</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-new-regression-tests" id="id13">Writing new regression tests</a></p></li>
<li><p><a class="reference internal" href="#extra-files" id="id14">Extra files</a></p></li>
<li><p><a class="reference internal" href="#fragile-tests" id="id15">Fragile tests</a></p></li>
<li><p><a class="reference internal" href="#platform-specific-tests" id="id16">Platform-Specific Tests</a></p></li>
<li><p><a class="reference internal" href="#constraining-test-execution" id="id17">Constraining test execution</a></p></li>
<li><p><a class="reference internal" href="#substitutions" id="id18">Substitutions</a></p></li>
<li><p><a class="reference internal" href="#options" id="id19">Options</a></p></li>
<li><p><a class="reference internal" href="#other-features" id="id20">Other Features</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document is the reference manual for the LLVM testing
infrastructure. It documents the structure of the LLVM testing
infrastructure, the tools needed to use it, and how to add and run
tests.</p>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id3">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>In order to use the LLVM testing infrastructure, you will need all of the
software required to build LLVM, as well as <a class="reference external" href="http://python.org">Python</a> 2.7 or
later.</p>
</div>
<div class="section" id="llvm-testing-infrastructure-organization">
<h2><a class="toc-backref" href="#id4">LLVM Testing Infrastructure Organization</a><a class="headerlink" href="#llvm-testing-infrastructure-organization" title="Permalink to this headline">¶</a></h2>
<p>The LLVM testing infrastructure contains three major categories of tests:
unit tests, regression tests and whole programs. The unit tests and regression
tests are contained inside the LLVM repository itself under <code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code>
and <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> respectively and are expected to always pass – they should be
run before every commit.</p>
<p>The whole programs tests are referred to as the “LLVM test suite” (or
“test-suite”) and are in the <code class="docutils literal notranslate"><span class="pre">test-suite</span></code> module in subversion. For
historical reasons, these tests are also referred to as the “nightly
tests” in places, which is less ambiguous than “test-suite” and remains
in use although we run them much more often than nightly.</p>
<div class="section" id="unit-tests">
<h3><a class="toc-backref" href="#id5">Unit tests</a><a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>Unit tests are written using <a class="reference external" href="https://github.com/google/googletest/blob/master/googletest/docs/primer.md">Google Test</a>
and <a class="reference external" href="https://github.com/google/googletest/blob/master/googlemock/docs/ForDummies.md">Google Mock</a>
and are located in the <code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code> directory.</p>
</div>
<div class="section" id="regression-tests">
<h3><a class="toc-backref" href="#id6">Regression tests</a><a class="headerlink" href="#regression-tests" title="Permalink to this headline">¶</a></h3>
<p>The regression tests are small pieces of code that test a specific
feature of LLVM or trigger a specific bug in LLVM. The language they are
written in depends on the part of LLVM being tested. These tests are driven by
the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">Lit</span></a> testing tool (which is part of LLVM), and
are located in the <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> directory.</p>
<p>Typically when a bug is found in LLVM, a regression test containing just
enough code to reproduce the problem should be written and placed
somewhere underneath this directory. For example, it can be a small
piece of LLVM IR distilled from an actual application or benchmark.</p>
</div>
<div class="section" id="test-suite">
<h3><a class="toc-backref" href="#id7"><code class="docutils literal notranslate"><span class="pre">test-suite</span></code></a><a class="headerlink" href="#test-suite" title="Permalink to this headline">¶</a></h3>
<p>The test suite contains whole programs, which are pieces of code which
can be compiled and linked into a stand-alone program that can be
executed. These programs are generally written in high level languages
such as C or C++.</p>
<p>These programs are compiled using a user specified compiler and set of
flags, and then executed to capture the program output and timing
information. The output of these programs is compared to a reference
output to ensure that the program is being compiled correctly.</p>
<p>In addition to compiling and executing programs, whole program tests
serve as a way of benchmarking LLVM performance, both in terms of the
efficiency of the programs generated as well as the speed with which
LLVM compiles, optimizes, and generates code.</p>
<p>The test-suite is located in the <code class="docutils literal notranslate"><span class="pre">test-suite</span></code> Subversion module.</p>
<p>See the <a class="reference internal" href="TestSuiteGuide.html"><span class="doc">test-suite Guide</span></a> for details.</p>
</div>
<div class="section" id="debugging-information-tests">
<h3><a class="toc-backref" href="#id8">Debugging Information tests</a><a class="headerlink" href="#debugging-information-tests" title="Permalink to this headline">¶</a></h3>
<p>The test suite contains tests to check quality of debugging information.
The test are written in C based languages or in LLVM assembly language.</p>
<p>These tests are compiled and run under a debugger. The debugger output
is checked to validate of debugging information. See README.txt in the
test suite for more information . This test suite is located in the
<code class="docutils literal notranslate"><span class="pre">debuginfo-tests</span></code> Subversion module.</p>
</div>
</div>
<div class="section" id="quick-start">
<h2><a class="toc-backref" href="#id9">Quick start</a><a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>The tests are located in two separate Subversion modules. The unit and
regression tests are in the main “llvm” module under the directories
<code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code> and <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> (so you get these tests for free with the
main LLVM tree). Use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-all</span></code> to run the unit and regression tests
after building LLVM.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">test-suite</span></code> module contains more comprehensive tests including whole C
and C++ programs. See the <a class="reference internal" href="TestSuiteGuide.html"><span class="doc">test-suite Guide</span></a> for details.</p>
<div class="section" id="unit-and-regression-tests">
<h3><a class="toc-backref" href="#id10">Unit and Regression tests</a><a class="headerlink" href="#unit-and-regression-tests" title="Permalink to this headline">¶</a></h3>
<p>To run all of the LLVM unit tests use the check-llvm-unit target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% make check-llvm-unit
</pre></div>
</div>
<p>To run all of the LLVM regression tests use the check-llvm target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% make check-llvm
</pre></div>
</div>
<p>In order to get reasonable testing performance, build LLVM and subprojects
in release mode, i.e.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% cmake -DCMAKE_BUILD_TYPE<span class="o">=</span><span class="s2">&quot;Release&quot;</span> -DLLVM_ENABLE_ASSERTIONS<span class="o">=</span>On
</pre></div>
</div>
<p>If you have <a class="reference external" href="http://clang.llvm.org/">Clang</a> checked out and built, you
can run the LLVM and Clang tests simultaneously using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% make check-all
</pre></div>
</div>
<p>To run the tests with Valgrind (Memcheck by default), use the <code class="docutils literal notranslate"><span class="pre">LIT_ARGS</span></code> make
variable to pass the required options to lit. For example, you can use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% make check <span class="nv">LIT_ARGS</span><span class="o">=</span><span class="s2">&quot;-v --vg --vg-leak&quot;</span>
</pre></div>
</div>
<p>to enable testing with valgrind and with leak checking enabled.</p>
<p>To run individual tests or subsets of tests, you can use the <code class="docutils literal notranslate"><span class="pre">llvm-lit</span></code>
script which is built as part of LLVM. For example, to run the
<code class="docutils literal notranslate"><span class="pre">Integer/BitPacked.ll</span></code> test by itself you can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% llvm-lit ~/llvm/test/Integer/BitPacked.ll
</pre></div>
</div>
<p>or to run all of the ARM CodeGen tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% llvm-lit ~/llvm/test/CodeGen/ARM
</pre></div>
</div>
<p>For more information on using the <strong class="program">lit</strong> tool, see <code class="docutils literal notranslate"><span class="pre">llvm-lit</span> <span class="pre">--help</span></code>
or the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">lit man page</span></a>.</p>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id11">Debugging Information tests</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>To run debugging information tests simply add the <code class="docutils literal notranslate"><span class="pre">debuginfo-tests</span></code>
project to your <code class="docutils literal notranslate"><span class="pre">LLVM_ENABLE_PROJECTS</span></code> define on the cmake
command-line.</p>
</div>
</div>
<div class="section" id="regression-test-structure">
<h2><a class="toc-backref" href="#id12">Regression test structure</a><a class="headerlink" href="#regression-test-structure" title="Permalink to this headline">¶</a></h2>
<p>The LLVM regression tests are driven by <strong class="program">lit</strong> and are located in the
<code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> directory.</p>
<p>This directory contains a large array of small tests that exercise
various features of LLVM and to ensure that regressions do not occur.
The directory is broken into several sub-directories, each focused on a
particular area of LLVM.</p>
<div class="section" id="writing-new-regression-tests">
<h3><a class="toc-backref" href="#id13">Writing new regression tests</a><a class="headerlink" href="#writing-new-regression-tests" title="Permalink to this headline">¶</a></h3>
<p>The regression test structure is very simple, but does require some
information to be set. This information is gathered via <code class="docutils literal notranslate"><span class="pre">configure</span></code>
and is written to a file, <code class="docutils literal notranslate"><span class="pre">test/lit.site.cfg</span></code> in the build directory.
The <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> Makefile does this work for you.</p>
<p>In order for the regression tests to work, each directory of tests must
have a <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> file. <strong class="program">lit</strong> looks for this file to determine
how to run the tests. This file is just Python code and thus is very
flexible, but we’ve standardized it for the LLVM regression tests. If
you’re adding a directory of tests, just copy <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> from
another directory to get running. The standard <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> simply
specifies which files to look in for tests. Any directory that contains
only directories does not need the <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> file. Read the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">Lit
documentation</span></a> for more information.</p>
<p>Each test file must contain lines starting with “RUN:” that tell <strong class="program">lit</strong>
how to run it. If there are no RUN lines, <strong class="program">lit</strong> will issue an error
while running a test.</p>
<p>RUN lines are specified in the comments of the test program using the
keyword <code class="docutils literal notranslate"><span class="pre">RUN</span></code> followed by a colon, and lastly the command (pipeline)
to execute. Together, these lines form the “script” that <strong class="program">lit</strong>
executes to run the test case. The syntax of the RUN lines is similar to a
shell’s syntax for pipelines including I/O redirection and variable
substitution. However, even though these lines may <em>look</em> like a shell
script, they are not. RUN lines are interpreted by <strong class="program">lit</strong>.
Consequently, the syntax differs from shell in a few ways. You can specify
as many RUN lines as needed.</p>
<p><strong class="program">lit</strong> performs substitution on each RUN line to replace LLVM tool names
with the full paths to the executable built for each tool (in
<code class="docutils literal notranslate"><span class="pre">$(LLVM_OBJ_ROOT)/$(BuildMode)/bin)</span></code>. This ensures that <strong class="program">lit</strong> does
not invoke any stray LLVM tools in the user’s path during testing.</p>
<p>Each RUN line is executed on its own, distinct from other lines unless
its last character is <code class="docutils literal notranslate"><span class="pre">\</span></code>. This continuation character causes the RUN
line to be concatenated with the next one. In this way you can build up
long pipelines of commands without making huge line lengths. The lines
ending in <code class="docutils literal notranslate"><span class="pre">\</span></code> are concatenated until a RUN line that doesn’t end in
<code class="docutils literal notranslate"><span class="pre">\</span></code> is found. This concatenated set of RUN lines then constitutes one
execution. <strong class="program">lit</strong> will substitute variables and arrange for the pipeline
to be executed. If any process in the pipeline fails, the entire line (and
test case) fails too.</p>
<p>Below is an example of legal RUN lines in a <code class="docutils literal notranslate"><span class="pre">.ll</span></code> file:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: llvm-as &lt; %s | llvm-dis &gt; %t1</span>
<span class="c">; RUN: llvm-dis &lt; %s.bc-13 &gt; %t2</span>
<span class="c">; RUN: diff %t1 %t2</span>
</pre></div>
</div>
<p>As with a Unix shell, the RUN lines permit pipelines and I/O
redirection to be used.</p>
<p>There are some quoting rules that you must pay attention to when writing
your RUN lines. In general nothing needs to be quoted. <strong class="program">lit</strong> won’t
strip off any quote characters so they will get passed to the invoked program.
To avoid this use curly braces to tell <strong class="program">lit</strong> that it should treat
everything enclosed as one value.</p>
<p>In general, you should strive to keep your RUN lines as simple as possible,
using them only to run tools that generate textual output you can then examine.
The recommended way to examine output to figure out if the test passes is using
the <a class="reference internal" href="CommandGuide/FileCheck.html"><span class="doc">FileCheck tool</span></a>. <em>[The usage of grep in RUN
lines is deprecated - please do not send or commit patches that use it.]</em></p>
<p>Put related tests into a single file rather than having a separate file per
test. Check if there are files already covering your feature and consider
adding your code there instead of creating a new file.</p>
</div>
<div class="section" id="extra-files">
<h3><a class="toc-backref" href="#id14">Extra files</a><a class="headerlink" href="#extra-files" title="Permalink to this headline">¶</a></h3>
<p>If your test requires extra files besides the file containing the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code>
lines, the idiomatic place to put them is in a subdirectory <code class="docutils literal notranslate"><span class="pre">Inputs</span></code>.
You can then refer to the extra files as <code class="docutils literal notranslate"><span class="pre">%S/Inputs/foo.bar</span></code>.</p>
<p>For example, consider <code class="docutils literal notranslate"><span class="pre">test/Linker/ident.ll</span></code>. The directory structure is
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">/</span>
  <span class="n">Linker</span><span class="o">/</span>
    <span class="n">ident</span><span class="o">.</span><span class="n">ll</span>
    <span class="n">Inputs</span><span class="o">/</span>
      <span class="n">ident</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">ll</span>
      <span class="n">ident</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">ll</span>
</pre></div>
</div>
<p>For convenience, these are the contents:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">;;;;; ident.ll:</span>

<span class="c">; RUN: llvm-link %S/Inputs/ident.a.ll %S/Inputs/ident.b.ll -S | FileCheck %s</span>

<span class="c">; Verify that multiple input llvm.ident metadata are linked together.</span>

<span class="c">; CHECK-DAG: !llvm.ident = !{!0, !1, !2}</span>
<span class="c">; CHECK-DAG: &quot;Compiler V1&quot;</span>
<span class="c">; CHECK-DAG: &quot;Compiler V2&quot;</span>
<span class="c">; CHECK-DAG: &quot;Compiler V3&quot;</span>

<span class="c">;;;;; Inputs/ident.a.ll:</span>

<span class="nv">!llvm.ident</span> <span class="p">=</span> <span class="p">!{</span><span class="nv nv-Anonymous">!0</span><span class="p">,</span> <span class="nv nv-Anonymous">!1</span><span class="p">}</span>
<span class="nv nv-Anonymous">!0</span> <span class="p">=</span> <span class="k">metadata</span> <span class="p">!{</span><span class="k">metadata</span> <span class="nv">!&quot;Compiler V1&quot;</span><span class="p">}</span>
<span class="nv nv-Anonymous">!1</span> <span class="p">=</span> <span class="k">metadata</span> <span class="p">!{</span><span class="k">metadata</span> <span class="nv">!&quot;Compiler V2&quot;</span><span class="p">}</span>

<span class="c">;;;;; Inputs/ident.b.ll:</span>

<span class="nv">!llvm.ident</span> <span class="p">=</span> <span class="p">!{</span><span class="nv nv-Anonymous">!0</span><span class="p">}</span>
<span class="nv nv-Anonymous">!0</span> <span class="p">=</span> <span class="k">metadata</span> <span class="p">!{</span><span class="k">metadata</span> <span class="nv">!&quot;Compiler V3&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>For symmetry reasons, <code class="docutils literal notranslate"><span class="pre">ident.ll</span></code> is just a dummy file that doesn’t
actually participate in the test besides holding the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> lines.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some existing tests use <code class="docutils literal notranslate"><span class="pre">RUN:</span> <span class="pre">true</span></code> in extra files instead of just
putting the extra files in an <code class="docutils literal notranslate"><span class="pre">Inputs/</span></code> directory. This pattern is
deprecated.</p>
</div>
</div>
<div class="section" id="fragile-tests">
<h3><a class="toc-backref" href="#id15">Fragile tests</a><a class="headerlink" href="#fragile-tests" title="Permalink to this headline">¶</a></h3>
<p>It is easy to write a fragile test that would fail spuriously if the tool being
tested outputs a full path to the input file.  For example, <strong class="program">opt</strong> by
default outputs a <code class="docutils literal notranslate"><span class="pre">ModuleID</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat example.ll
<span class="go">define i32 @main() nounwind {</span>
<span class="go">    ret i32 0</span>
<span class="go">}</span>

<span class="gp">$</span> opt -S /path/to/example.ll
<span class="go">; ModuleID = &#39;/path/to/example.ll&#39;</span>

<span class="go">define i32 @main() nounwind {</span>
<span class="go">    ret i32 0</span>
<span class="go">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ModuleID</span></code> can unexpectedly match against <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> lines.  For example:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: opt -S %s | FileCheck</span>

<span class="k">define</span> <span class="k">i32</span> <span class="vg">@main</span><span class="p">()</span> <span class="k">nounwind</span> <span class="p">{</span>
    <span class="c">; CHECK-NOT: load</span>
    <span class="k">ret</span> <span class="k">i32</span> <span class="m">0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This test will fail if placed into a <code class="docutils literal notranslate"><span class="pre">download</span></code> directory.</p>
<p>To make your tests robust, always use <code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">...</span> <span class="pre">&lt;</span> <span class="pre">%s</span></code> in the RUN line.
<strong class="program">opt</strong> does not output a <code class="docutils literal notranslate"><span class="pre">ModuleID</span></code> when input comes from stdin.</p>
</div>
<div class="section" id="platform-specific-tests">
<h3><a class="toc-backref" href="#id16">Platform-Specific Tests</a><a class="headerlink" href="#platform-specific-tests" title="Permalink to this headline">¶</a></h3>
<p>Whenever adding tests that require the knowledge of a specific platform,
either related to code generated, specific output or back-end features,
you must make sure to isolate the features, so that buildbots that
run on different architectures (and don’t even compile all back-ends),
don’t fail.</p>
<p>The first problem is to check for target-specific output, for example sizes
of structures, paths and architecture names, for example:</p>
<ul class="simple">
<li><p>Tests containing Windows paths will fail on Linux and vice-versa.</p></li>
<li><p>Tests that check for <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> somewhere in the text will fail anywhere else.</p></li>
<li><p>Tests where the debug information calculates the size of types and structures.</p></li>
</ul>
<p>Also, if the test rely on any behaviour that is coded in any back-end, it must
go in its own directory. So, for instance, code generator tests for ARM go
into <code class="docutils literal notranslate"><span class="pre">test/CodeGen/ARM</span></code> and so on. Those directories contain a special
<code class="docutils literal notranslate"><span class="pre">lit</span></code> configuration file that ensure all tests in that directory will
only run if a specific back-end is compiled and available.</p>
<p>For instance, on <code class="docutils literal notranslate"><span class="pre">test/CodeGen/ARM</span></code>, the <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.ll&#39;</span><span class="p">,</span> <span class="s1">&#39;.c&#39;</span><span class="p">,</span> <span class="s1">&#39;.cpp&#39;</span><span class="p">,</span> <span class="s1">&#39;.test&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ARM&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
  <span class="n">config</span><span class="o">.</span><span class="n">unsupported</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Other platform-specific tests are those that depend on a specific feature
of a specific sub-architecture, for example only to Intel chips that support <code class="docutils literal notranslate"><span class="pre">AVX2</span></code>.</p>
<p>For instance, <code class="docutils literal notranslate"><span class="pre">test/CodeGen/X86/psubus.ll</span></code> tests three sub-architecture
variants:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: llc -mcpu=core2 &lt; %s | FileCheck %s -check-prefix=SSE2</span>
<span class="c">; RUN: llc -mcpu=corei7-avx &lt; %s | FileCheck %s -check-prefix=AVX1</span>
<span class="c">; RUN: llc -mcpu=core-avx2 &lt; %s | FileCheck %s -check-prefix=AVX2</span>
</pre></div>
</div>
<p>And the checks are different:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; SSE2: @test1</span>
<span class="c">; SSE2: psubusw LCPI0_0(%rip), %xmm0</span>
<span class="c">; AVX1: @test1</span>
<span class="c">; AVX1: vpsubusw LCPI0_0(%rip), %xmm0, %xmm0</span>
<span class="c">; AVX2: @test1</span>
<span class="c">; AVX2: vpsubusw LCPI0_0(%rip), %xmm0, %xmm0</span>
</pre></div>
</div>
<p>So, if you’re testing for a behaviour that you know is platform-specific or
depends on special features of sub-architectures, you must add the specific
triple, test with the specific FileCheck and put it into the specific
directory that will filter out all other architectures.</p>
</div>
<div class="section" id="constraining-test-execution">
<h3><a class="toc-backref" href="#id17">Constraining test execution</a><a class="headerlink" href="#constraining-test-execution" title="Permalink to this headline">¶</a></h3>
<p>Some tests can be run only in specific configurations, such as
with debug builds or on particular platforms. Use <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code>
and <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> to control when the test is enabled.</p>
<p>Some tests are expected to fail. For example, there may be a known bug
that the test detect. Use <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> to mark a test as an expected failure.
An <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> test will be successful if its execution fails, and
will be a failure if its execution succeeds.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; This test will be only enabled in the build with asserts.</span>
<span class="c">; REQUIRES: asserts</span>
<span class="c">; This test is disabled on Linux.</span>
<span class="c">; UNSUPPORTED: -linux-</span>
<span class="c">; This test is expected to fail on PowerPC.</span>
<span class="c">; XFAIL: powerpc</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> and <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> and <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> all accept a comma-separated
list of boolean expressions. The values in each expression may be:</p>
<ul class="simple">
<li><p>Features added to <code class="docutils literal notranslate"><span class="pre">config.available_features</span></code> by
configuration files such as <code class="docutils literal notranslate"><span class="pre">lit.cfg</span></code>.</p></li>
<li><p>Substrings of the target triple (<code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> and <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> only).</p></li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> enables the test if all expressions are true.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> disables the test if any expression is true.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> expects the test to fail if any expression is true.</div>
</div>
<p>As a special case, <code class="docutils literal notranslate"><span class="pre">XFAIL:</span> <span class="pre">*</span></code> is expected to fail everywhere.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; This test is disabled on Windows,</span>
<span class="c">; and is disabled on Linux, except for Android Linux.</span>
<span class="c">; UNSUPPORTED: windows, linux &amp;&amp; !android</span>
<span class="c">; This test is expected to fail on both PowerPC and ARM.</span>
<span class="c">; XFAIL: powerpc || arm</span>
</pre></div>
</div>
</div>
<div class="section" id="substitutions">
<h3><a class="toc-backref" href="#id18">Substitutions</a><a class="headerlink" href="#substitutions" title="Permalink to this headline">¶</a></h3>
<p>Besides replacing LLVM tool names the following substitutions are performed in
RUN lines:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">%%</span></code></dt><dd><p>Replaced by a single <code class="docutils literal notranslate"><span class="pre">%</span></code>. This allows escaping other substitutions.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%s</span></code></dt><dd><p>File path to the test case’s source. This is suitable for passing on the
command line as the input to an LLVM tool.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm/test/MC/ELF/foo_test.s</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%S</span></code></dt><dd><p>Directory path to the test case’s source.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm/test/MC/ELF</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%t</span></code></dt><dd><p>File path to a temporary file name that could be used for this test case.
The file name won’t conflict with other test cases. You can append to it
if you need multiple temporaries. This is useful as the destination of
some redirected output.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm.build/test/MC/ELF/Output/foo_test.s.tmp</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%T</span></code></dt><dd><p>Directory of <code class="docutils literal notranslate"><span class="pre">%t</span></code>. Deprecated. Shouldn’t be used, because it can be easily
misused and cause race conditions between tests.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">%t</span> <span class="pre">&amp;&amp;</span> <span class="pre">mkdir</span> <span class="pre">%t</span></code> instead if a temporary directory is necessary.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm.build/test/MC/ELF/Output</span></code></p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">%{pathsep}</span></code></p>
<blockquote>
<div><p>Expands to the path separator, i.e. <code class="docutils literal notranslate"><span class="pre">:</span></code> (or <code class="docutils literal notranslate"><span class="pre">;</span></code> on Windows).</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%/s,</span> <span class="pre">%/S,</span> <span class="pre">%/t,</span> <span class="pre">%/T:</span></code></p>
<blockquote>
<div><p>Act like the corresponding substitution above but replace any <code class="docutils literal notranslate"><span class="pre">\</span></code>
character with a <code class="docutils literal notranslate"><span class="pre">/</span></code>. This is useful to normalize path separators.</p>
<blockquote>
<div><p>Example: <code class="docutils literal notranslate"><span class="pre">%s:</span>&#160; <span class="pre">C:\Desktop</span> <span class="pre">Files/foo_test.s.tmp</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">%/s:</span> <span class="pre">C:/Desktop</span> <span class="pre">Files/foo_test.s.tmp</span></code></p>
</div></blockquote>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%:s,</span> <span class="pre">%:S,</span> <span class="pre">%:t,</span> <span class="pre">%:T:</span></code></p>
<blockquote>
<div><p>Act like the corresponding substitution above but remove colons at
the beginning of Windows paths. This is useful to allow concatenation
of absolute paths on Windows to produce a legal path.</p>
<blockquote>
<div><p>Example: <code class="docutils literal notranslate"><span class="pre">%s:</span>&#160; <span class="pre">C:\Desktop</span> <span class="pre">Files\foo_test.s.tmp</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">%:s:</span> <span class="pre">C\Desktop</span> <span class="pre">Files\foo_test.s.tmp</span></code></p>
</div></blockquote>
</div></blockquote>
<p><strong>LLVM-specific substitutions:</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">%shlibext</span></code></dt><dd><p>The suffix for the host platforms shared library files. This includes the
period as the first character.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">.so</span></code> (Linux), <code class="docutils literal notranslate"><span class="pre">.dylib</span></code> (macOS), <code class="docutils literal notranslate"><span class="pre">.dll</span></code> (Windows)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%exeext</span></code></dt><dd><p>The suffix for the host platforms executable files. This includes the
period as the first character.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">.exe</span></code> (Windows), empty on Linux.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%(line)</span></code>, <code class="docutils literal notranslate"><span class="pre">%(line+&lt;number&gt;)</span></code>, <code class="docutils literal notranslate"><span class="pre">%(line-&lt;number&gt;)</span></code></dt><dd><p>The number of the line where this substitution is used, with an optional
integer offset. This can be used in tests with multiple RUN lines, which
reference test file’s line numbers.</p>
</dd>
</dl>
<p><strong>Clang-specific substitutions:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">%clang</span></code></dt><dd><p>Invokes the Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cpp</span></code></dt><dd><p>Invokes the Clang driver for C++.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cl</span></code></dt><dd><p>Invokes the CL-compatible Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clangxx</span></code></dt><dd><p>Invokes the G++-compatible Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cc1</span></code></dt><dd><p>Invokes the Clang frontend.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%itanium_abi_triple</span></code>, <code class="docutils literal notranslate"><span class="pre">%ms_abi_triple</span></code></dt><dd><p>These substitutions can be used to get the current target triple adjusted to
the desired ABI. For example, if the test suite is running with the
<code class="docutils literal notranslate"><span class="pre">i686-pc-win32</span></code> target, <code class="docutils literal notranslate"><span class="pre">%itanium_abi_triple</span></code> will expand to
<code class="docutils literal notranslate"><span class="pre">i686-pc-mingw32</span></code>. This allows a test to run with a specific ABI without
constraining it to a specific triple.</p>
</dd>
</dl>
<p>To add more substituations, look at <code class="docutils literal notranslate"><span class="pre">test/lit.cfg</span></code> or <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code>.</p>
</div>
<div class="section" id="options">
<h3><a class="toc-backref" href="#id19">Options</a><a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h3>
<p>The llvm lit configuration allows to customize some things with user options:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">llc</span></code>, <code class="docutils literal notranslate"><span class="pre">opt</span></code>, …</dt><dd><p>Substitute the respective llvm tool name with a custom command line. This
allows to specify custom paths and default arguments for these tools.
Example:</p>
<p>% llvm-lit “-Dllc=llc -verify-machineinstrs”</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">run_long_tests</span></code></dt><dd><p>Enable the execution of long running tests.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">llvm_site_config</span></code></dt><dd><p>Load the specified lit configuration instead of the default one.</p>
</dd>
</dl>
</div>
<div class="section" id="other-features">
<h3><a class="toc-backref" href="#id20">Other Features</a><a class="headerlink" href="#other-features" title="Permalink to this headline">¶</a></h3>
<p>To make RUN line writing easier, there are several helper programs. These
helpers are in the PATH when running tests, so you can just call them using
their name. For example:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">not</span></code></dt><dd><p>This program runs its arguments and then inverts the result code from it.
Zero result codes become 1. Non-zero result codes become 0.</p>
</dd>
</dl>
<p>To make the output more useful, <strong class="program">lit</strong> will scan
the lines of the test case for ones that contain a pattern that matches
<code class="docutils literal notranslate"><span class="pre">PR[0-9]+</span></code>. This is the syntax for specifying a PR (Problem Report) number
that is related to the test case. The number after “PR” specifies the
LLVM bugzilla number. When a PR number is specified, it will be used in
the pass/fail reporting. This is useful to quickly get some context when
a test fails.</p>
<p>Finally, any line that contains “END.” will cause the special
interpretation of lines to terminate. This is generally done right after
the last RUN: line. This has two side effects:</p>
<ol class="loweralpha simple">
<li><p>it prevents special interpretation of lines that are part of the test
program, not the instructions to the test case, and</p></li>
<li><p>it speeds things up for really big test cases by avoiding
interpretation of the remainder of the file.</p></li>
</ol>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="TestSuiteGuide.html" title="test-suite Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="Phabricator.html" title="Code Reviews with Phabricator"
             >previous</a> |</li>
  <li><a href="http://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2003-2020, LLVM Project.
      Last updated on 2020-01-13.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>